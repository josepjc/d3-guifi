<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Big Data Week Hackaton Forum Network</title>
                <link type="text/css" href="css/network.css" rel="stylesheet" />
		<script type="text/javascript" src="d3/d3.v3.min.js"></script>
	</head>
	<body>

	<div align="center">:: Pots fer zoom amb la rodeta del ratol&iacute; :: Posa el ratol&iacute; a sobre del punt per veure la llegenda ::  <b><i><font color="orange">&nbsp;Toronja</font></i></b> = Supernodes&nbsp; <font color="#6633ff"><i><b>Blau</b></i></font> =
Clients&nbsp; <i><b><font color="red">Vermell</font></b></i>
= AP</div>

            <script type="text/javascript" charset="utf-8">
                    var vis = d3.select("body")
                                .append("svg")
                                .attr("width", 1550)
                                .attr("height", 1130);
                    var container = vis.append("g")

                    redraw = function()
                    {
                        container.attr("transform",
                            "translate(" + d3.event.translate + ")"
                            + " scale(" + d3.event.scale + ")");
                    }

                    d3.json("data/guifi-d3-plana-de-vic.json",function(data){
                        var width = 1200, height = 800;

                        var nodeSizeScale = d3.scale.sqrt().range([1,90]).domain([0,200]);

                        var labelDistance = 0;

                        zoom = d3.behavior.zoom();
                        zoom.scaleExtent([0.2,270]);


                        var nodes = [];
                        var links = [];
                        var nodes_aux = {};

                        vis.on("mousemove", mousemove);
                        vis.call(zoom.on("zoom", redraw));

                        var tooltip =  d3.select("body").append("div")
                           .attr("id","tooltip")
                           .html("")
                           .attr("class", "tooltip")
                           .style("display","none");

                       function mousemove()
                       {
                           d3.selectAll(".tooltip")
                               .style("opacity",function(d){return 1.0;})
                               .style("left", (d3.event.pageX +20) + "px")
                               .style("top", (d3.event.pageY - 12) + "px");
                       }


                        data.nodes.forEach(function(d){
                                        var node = nodes.push({label:d.name,type:d.type,id:d.id}) - 1 ;
                                        nodes_aux[d.id]=node;
                        });
                        data.links.forEach(function(d){
                                        var link = {id:d.id,source:nodes[nodes_aux[d.source]],target:nodes[nodes_aux[d.target]],weight:1};
                                        if(link.source!=null && link.target!=null){
                                            links.push(link);
                                        }
                                        else{
                                            //console.log(link);
                                        }
                                    }
                            );

                        var force = d3.layout.force().size([width, height]).nodes(nodes,function(d){return d.id;}).links(links).gravity(1).linkDistance(50).charge(-5000).linkStrength(10);

                        force.start();

                        var link = container.selectAll("line.link").data(links,function(d){return d.id;}).enter().append("line").attr("class", "link").style("stroke", "#CCC");

                        var node = container.selectAll(".node").data(force.nodes()).enter().append("g").attr("class", "node");
                        var circles = node.append("circle").attr("r", function(d){return nodeSizeScale(d.weight);}).attr("class",function(d){if(d.type=='ap'){return "circulo user";}else{if(d.type=='client'){return "circulo topic";}else{if(d.type=='Supernode'){return "circulo forum";}else{return "circulo rest"}}}});
                        circles.on("mouseout",function(d){console.log("OUTTTTTTTTT");console.log(tooltip);tooltip.style("display","none");});
                        circles.on("mouseover",function(d){
                                  tooltip.style("display","block").style("font-family","arial").html("<span class='big'>"+d.label+"</span>");
                              });
                        //circles.call(force.drag);


                        var updateLink = function() {
                                this.attr("x1", function(d) {
                                        return d.source.x;
                                }).attr("y1", function(d) {
                                        return d.source.y;
                                }).attr("x2", function(d) {
                                        return d.target.x;
                                }).attr("y2", function(d) {
                                        return d.target.y;
                                });

                        }

                        var updateNode = function() {
                                this.attr("transform", function(d) {
                                        return "translate(" + d.x + "," + d.y + ")";
                                });

                        }


                        force.on("tick", function() {

                                node.call(updateNode);
                                link.call(updateLink);
                        });

                      });
		</script>
	</body>
</html>
